#!/usr/bin/env bash
set -euo pipefail

BASE="zabbix-ansible"
mkdir -p "$BASE"/{group_vars,roles/zabbix_agent/{tasks,templates,handlers}}

cat > "$BASE/inventory" << 'EOF'
[zabbix_monitored]
host1 ansible_host=192.0.2.10
host2 ansible_host=192.0.2.11

[zabbix_server]
zabbix.example.com ansible_host=10.0.0.5
EOF

cat > "$BASE/group_vars/all.yml" << 'EOF'
---
zabbix_api_url: "http://zabbix.example.com/zabbix/api_jsonrpc.php"
zabbix_api_user: "api_user"
zabbix_api_password: "secret_password"

zabbix_default_groups:
  - "Linux servers"
zabbix_default_templates:
  - "Template OS Linux by Zabbix agent 2"

zabbix_agent_port: "10050"
zabbix_server_address: "zabbix.example.com"
EOF

cat > "$BASE/site.yml" << 'EOF'
---
- name: Install and configure Zabbix Agent2 on monitored hosts
  hosts: zabbix_monitored
  become: yes
  gather_facts: yes
  roles:
    - role: zabbix_agent

- name: Register hosts in Zabbix Server via API
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - community.zabbix
  vars_files:
    - group_vars/all.yml
  tasks:
    - name: Build registration payload for each monitored host
      set_fact:
        zabbix_hosts: "{{ zabbix_hosts | default([]) + [ {
          'host_name': item,
          'visible_name': hostvars[item].inventory_hostname | default(item),
          'interfaces': [{
            'type': 'agent',
            'main': 1,
            'useip': 1,
            'ip': (hostvars[item]['ansible_default_ipv4']['address']
                   | default(hostvars[item]['ansible_all_ipv4_addresses'][0] | default('127.0.0.1'))),
            'dns': '',
            'port': zabbix_agent_port
          }],
          'host_groups': hostvars[item].zabbix_host_groups | default(zabbix_default_groups),
          'link_templates': hostvars[item].zabbix_host_templates | default(zabbix_default_templates)
        } ] }}"
      loop: "{{ groups['zabbix_monitored'] }}"
      loop_control:
        loop_var: item

    - name: Ensure hosts exist in Zabbix
      community.zabbix.zabbix_host:
        server_url: "{{ zabbix_api_url }}"
        login_user: "{{ zabbix_api_user }}"
        login_password: "{{ zabbix_api_password }}"
        host_name: "{{ item.host_name }}"
        visible_name: "{{ item.visible_name }}"
        interfaces: "{{ item.interfaces }}"
        host_groups: "{{ item.host_groups }}"
        link_templates: "{{ item.link_templates }}"
        inventory_mode: "automatic"
        state: present
      loop: "{{ zabbix_hosts }}"
EOF

cat > "$BASE/roles/zabbix_agent/tasks/main.yml" << 'EOF'
---
- name: Include OS specific tasks
  include_tasks: "{{ 'debian.yml' if ansible_facts['os_family'] == 'Debian' else 'redhat.yml' }}"
EOF

cat > "$BASE/roles/zabbix_agent/tasks/debian.yml" << 'EOF'
---
- name: Add Zabbix apt repo package
  apt:
    deb: "https://repo.zabbix.com/zabbix/6.0/debian/pool/main/z/zabbix-release/zabbix-release_6.0-1+{{ ansible_distribution_release }}_all.deb"
  register: addrepo
  changed_when: "'installed' in addrepo.stdout or addrepo is changed"
  ignore_errors: yes

- name: apt update
  apt:
    update_cache: yes
  when: addrepo is changed or addrepo is succeeded

- name: Install zabbix-agent2 package
  apt:
    name: zabbix-agent2
    state: present
    update_cache: yes

- name: Deploy zabbix_agent2.conf
  template:
    src: zabbix_agent2.conf.j2
    dest: /etc/zabbix/zabbix_agent2.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart zabbix-agent2

- name: Ensure zabbix-agent2 enabled and started
  systemd:
    name: zabbix-agent2
    enabled: yes
    state: started
EOF

cat > "$BASE/roles/zabbix_agent/tasks/redhat.yml" << 'EOF'
---
- name: Install zabbix repo RPM
  yum:
    name: "https://repo.zabbix.com/zabbix/6.0/rhel/{{ ansible_distribution_major_version }}/x86_64/zabbix-release-6.0-1.el{{ ansible_distribution_major_version }}.noarch.rpm"
    state: present
  ignore_errors: yes

- name: Clean yum cache
  command: dnf makecache
  become: yes
  when: ansible_facts['pkg_mgr'] == 'dnf'
  ignore_errors: yes

- name: Install zabbix-agent2
  package:
    name: zabbix-agent2
    state: present

- name: Deploy zabbix_agent2.conf
  template:
    src: zabbix_agent2.conf.j2
    dest: /etc/zabbix/zabbix_agent2.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart zabbix-agent2

- name: Ensure zabbix-agent2 enabled and started (systemd)
  systemd:
    name: zabbix-agent2
    enabled: yes
    state: started
EOF

cat > "$BASE/roles/zabbix_agent/handlers/main.yml" << 'EOF'
---
- name: restart zabbix-agent2
  become: yes
  systemd:
    name: zabbix-agent2
    state: restarted
EOF

cat > "$BASE/roles/zabbix_agent/templates/zabbix_agent2.conf.j2" << 'EOF'
PidFile=/var/run/zabbix/zabbix_agent2.pid
LogFile=/var/log/zabbix/zabbix_agent2.log
Server={{ zabbix_server_address }}
ServerActive={{ zabbix_server_address }}
Hostname={{ inventory_hostname }}
ListenPort={{ zabbix_agent_port }}
EOF

echo "Проект создан в ./$BASE"
